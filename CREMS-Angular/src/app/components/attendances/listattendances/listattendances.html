<div class="card">
  <div class="card-datatable table-responsive pt-0">
    <div class="dt-container dt-bootstrap5 dt-empty-footer">
      
      <!-- Header -->
      <div class="row card-header flex-column flex-md-row border-bottom mx-0 px-3">
        <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto mt-0">
          <h5 class="card-title mb-0 text-md-start text-center pb-md-0 pb-2">
            Attendance ({{ selectedDate | date: 'yyyy-MM-dd' }})
          </h5>
        </div>
        <div class="col-md-4 mt-2 mt-md-0">
          <input
            type="date"
            class="form-control border border-primary"
            [(ngModel)]="selectedDate"
            (change)="onDateChange()"
          />
        </div>
      </div>

      <!-- Table -->
      <div class="row mx-0 px-3 my-0 justify-content-between border-bottom">
        <div class="dt-layout-table w-100">
          <div class="table-responsive">
            <ng-container *ngIf="dateRestriction; else outOfRange">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Employee Name</th>
                    <th>Salary</th>
                    <th>Attendance</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let labourId of stage?.labours ?? []; index as i">
                    <td>{{ i + 1 }}</td>
                    <td>{{ getEmployeeName(labourId) }}</td>
                    <td>{{ getEmployeeSalary(labourId) }}</td>
                    <td>
                      <ng-container *ngIf="getAttendanceByLabour(labourId); else showButtons">
                        <!-- Present Button -->
                        <button
                          class="btn mx-1"
                          [ngClass]="{
                            'btn-success': getAttendanceByLabour(labourId) === 'Present',
                            'btn-outline-success': getAttendanceByLabour(labourId) !== 'Present'
                          }"
                          (click)="editAttendance(getAttendanceIDByLabour(labourId), labourId, 'Present', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-check"></i>
                        </button>

                        <!-- Absent Button -->
                        <button
                          class="btn mx-1"
                          [ngClass]="{
                            'btn-danger': getAttendanceByLabour(labourId) === 'Absent',
                            'btn-outline-danger': getAttendanceByLabour(labourId) !== 'Absent'
                          }"
                          (click)="editAttendance(getAttendanceIDByLabour(labourId), labourId, 'Absent', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-times"></i>
                        </button>

                        <!-- On Leave Button -->
                        <button
                          class="btn mx-1"
                          [ngClass]="{
                            'btn-warning': getAttendanceByLabour(labourId) === 'On Leave',
                            'btn-outline-warning': getAttendanceByLabour(labourId) !== 'On Leave'
                          }"
                          (click)="editAttendance(getAttendanceIDByLabour(labourId), labourId, 'On Leave', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-clock"></i>
                        </button>
                      </ng-container>

                      <ng-template #showButtons>
                        <!-- Initial Save Buttons -->
                        <button
                          class="btn btn-outline-success mx-1"
                          (click)="saveAttendance(labourId, 'Present', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-check"></i>
                        </button>
                        <button
                          class="btn btn-outline-danger mx-1"
                          (click)="saveAttendance(labourId, 'Absent', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-times"></i>
                        </button>
                        <button
                          class="btn btn-outline-warning mx-1"
                          (click)="saveAttendance(labourId, 'On Leave', getBaseSalary(labourId))"
                        >
                          <i class="fas fa-user-clock"></i>
                        </button>
                      </ng-template>
                    </td>
                  </tr>

                  <!-- Total Row -->
                  <tr class="table-info fw-bold">
                    <td colspan="2" class="text-end">Total Salary</td>
                    <td>{{ getTotalSalary() }}</td>
                    <td>
                      <button
                        *ngIf="!isPaid()"
                        class="btn btn-primary"
                        (click)="onPay()"
                      >
                        Pay
                      </button>
                      <span *ngIf="isPaid()" class="text-success fw-bold">Paid</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-container>

            <!-- Out of range alert -->
            <ng-template #outOfRange>
              <div class="alert alert-warning text-center my-3">
                Selected date is outside the stage duration.
              </div>
            </ng-template>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
